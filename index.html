<html>
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://cdn.steemjs.com/lib/latest/steem.min.js"></script>
	<link rel="icon" href="favicon.ico" />
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://www.w3schools.com/lib/w3.css">
	<title>SteemRandomDraw</title>
</head>
<body class="w3-content w3-padding-large" style="max-width:1200px;">
	<div id="err_div" class="w3-panel w3-red w3-display-container">
  		<span onclick="this.parentElement.style.display='none'" class="w3-button w3-red w3-large w3-display-topright">&times;</span>
  		<h3 id="err_title">Error !</h3>
  		<p id="err_body"></p>
	</div>

	<div class="w3-half w3-padding-large">
		<div class="w3-container w3-blue w3-center">
			<h3>Steem Random draw !</h3>
		</div>
		<div class="w3-container w3-card-4 w3-padding-large">
			<form class="w3-container" id="link_form" method="post">
				<p>
					<label class="w3-text-blue"><b>1 - Put the link to your article : </b></label>
					<input class="w3-input w3-border w3-round" type="text" name="link_field" placeholder="https://busy.org/@deadzy/..." id="link_field">
				</p>
				<label class="w3-text-blue"><b><p>2 - Select the required options : </p></b></label>
				<p class="w3-center">
					<input class="w3-check" type="checkbox" checked="checked" id="vote_box">
					<label class="w3-text-blue"><b>Votes</b> </label>
					<input class="w3-check" type="checkbox" id="coms_box">
					<label class="w3-text-blue"><b>Comments</b></label>
				</p>
				<label class="w3-text-blue"><b>3 - Options : </b></label>
				<p>
					<label class="w3-text-blue"><b>Minimum voting percentage to be eligible for the draw : </b></label>
					<input class="w3-input w3-border w3-round" type="number" name="vote_field" placeholder="(Optional)" id="vote_field" min="0" max="100">
				</p>
				<p>
					<label class="w3-text-blue"><b>Participation Commentary : </b></label>
					<input class="w3-input w3-border w3-round" type="text" name="coms_field" placeholder='(Optional)' id="coms_field" value="">
				</p>

				<p id="wait" class="w3-center"><i class="fa fa-spinner w3-spin" style="font-size:64px"></i></p>

				<button class="w3-button w3-block w3-section w3-blue w3-ripple w3-padding" type="submit">Submit</button>
			</form>
		</div>
	</div>
	<div class="w3-half w3-padding-large w3-animate-opacity" id="result">

		<div class="w3-container w3-blue w3-center">
			<h3>And the winner is ...</h3>
		</div>
		<div class="w3-container w3-card-4 w3-padding-large w3-center w3-margin-bottom">
			<div class="w3-panel w3-yellow w3-topbar w3-bottombar w3-border-amber" id="winner"></div>
		</div>

		<div class="w3-container w3-blue w3-center">
			<h3>Result</h3>
		</div>
		<div class="w3-container w3-card-4 w3-padding-large w3-responsive">
			<table class="w3-table-all w3-centered">
				<thead>
					<tr class="w3-light-grey">
						<th></th>
						<th>Upvotes</th>
						<th>Commentaires</th>
					</tr>
				</thead>
				<tbody>
					<tr>
						<th>All</th>
						<td class="vote_nb">-</td>
						<td class="coms_nb">-</td>
					</tr>
					<tr>
						<th >Valid</th>
						<td class="vote_nb_valid">-</td>
						<td class="coms_nb_valid">-</td>
					</tr>
				</tbody>
			</table>
		</div>
	</div>

	<div class="w3-container w3-padding-large w3-animate-opacity" id="participants">	
		<div class="w3-container w3-blue w3-center">
			<h3>List of participants</h3>
		</div>
		<div class="w3-container w3-card-4 w3-padding-large">
			<table class="w3-table-all w3-centered w3-hoverable">
				<thead>	
					<tr class="w3-light-grey">
						<th>N°</th>
	      				<th>Pseudo</th>
	   				</tr>
	   			</thead>
	   			<tbody id="tab">
   				<tbody>
			</table>
		</div>
	</div>

	<script>
		$(document).ready(function()
		{
			steem.api.setOptions({ url: 'https://api.steemit.com' });
		})

		$('#wait').hide();
		$('#participants').hide();
		$('#result').hide();
		$('#err_div').hide();

		var number_of_draws = "1";

		var vote_participant = [];
		var coms_participant = [];
		var participants = [];

		// FUNCTION

		function getAuthorPermlink(link_full)
		{
			console.log("getAuthorPermlink");

			var regex = new RegExp("/@");

			if (regex.test(link_full) == true)
			{
				link_split = link_full.split("/@")[1];
				sessionStorage.setItem("author", link_split.split("/")[0]);
				console.log(sessionStorage.getItem("author"));
				sessionStorage.setItem("permlink", link_split.split("/")[1]);
				console.log(sessionStorage.getItem("permlink"));
				return true;
			}
			else
			{
				$('#err_title').html("Error");
				$('#err_body').html("Please, Provide a valid link like https://busy.org/fr/@deadzy/my-contribution");
				$('#err_div').show();
				return false;
			}
		}

		async function getInfoFull(author, permlink)
		{
			console.log("getInfoFull");

			await steem.api.getContent(author, permlink, function(err, result) 
			{
				//console.log(err, result);
				if (result.active_votes != "" && err == null) 
				{
					sessionStorage.setItem("vote", JSON.stringify(result.active_votes));

					vote_list = JSON.parse(sessionStorage.getItem("vote"));
					console.log(vote_list);
					vote_min = $('#vote_field')[0].value; // Minimum voting percentage
					i = 0;
					vote_valid = 0; // Votes valid
					sessionStorage.setItem("vote_nb", vote_list.length);
					if (vote_min !== null && vote_min !== "") { vote_min = vote_min*100; }
					else { vote_min = 0; }
					while (i < vote_list.length)
					{
					    if(vote_list[i].percent >= vote_min)
					    {
					       	vote_participant.push(vote_list[i].voter);
					    	vote_valid++;
					    }
					    i++;
					}
					sessionStorage.setItem("vote_valid", vote_valid);
				}
			});

			await steem.api.getContentReplies(author, permlink, function(err, result)
			{
				//console.log(err, result);
				if(result != "" && err == null)
				{
					sessionStorage.setItem("coms", JSON.stringify(result));

					coms_list = JSON.parse(sessionStorage.getItem("coms"));
					console.log(coms_list);
					coms_text = $('#coms_field')[0].value; // Minimum voting percentage
					i = 0;
					coms_valid = 0; // Commentarys valid
					sessionStorage.setItem("coms_nb", coms_list.length);
					while (i < sessionStorage.getItem("coms_nb"))
					{
						var regex =  new RegExp(coms_text, "ig");
						if(regex.test(coms_list[i].body) == true)
						{
							coms_participant.push(coms_list[i].author);
						 	coms_valid++;
						}
					    i++;
					}
					sessionStorage.setItem("coms_valid", coms_valid);
				}
			});
		}

		function getRandomDraw()
		{
			console.log("getRandomDraw");

			if($("#coms_box").is(":checked") == true)
			{
				if($("#vote_box").is(":checked") == true)
				{
					participant_lenght = vote_participant.length;
					x = 0;
					for (i = 0; i < participant_lenght; i++)
					{	
						if($.inArray(vote_participant[i], coms_participant) >= 0)
						{
							participants.push(vote_participant[i]);
							x++;
							$("#tab").append("<tr><td>"+x+"</td><td>"+vote_participant[i]+"</td></tr>");
						}
					}
					num = randomNumber(participants.length);
					sessionStorage.setItem("winner", participants[num]);
				}
				else
				{
					participant_lenght = coms_participant.length;
					x = 0;
					for (i = 0; i < participant_lenght; i++)
					{
						x++;
						$("#tab").append("<tr><td>"+x+"</td><td>"+coms_participant[i]+"</td></tr>");
					}
					num = randomNumber(coms_participant.length);
					sessionStorage.setItem("winner", coms_participant[num]);
				}
			}
			else
			{
				participant_lenght = vote_participant.length;
				x = 0;
				for (i = 0; i < participant_lenght; i++)
				{
					x++;
					$("#tab").append("<tr><td>"+x+"</td><td>"+vote_participant[i]+"</td></tr>");
				}
				num = randomNumber(vote_participant.length);
				sessionStorage.setItem("winner", vote_participant[num]);
			}
			getResult();
		}

		function getResult()
		{
			console.log("getResult");

			sessionStorage.setItem("num_of_draws", number_of_draws++);

			$("#winner").append("<h1><a href='https://busy.org/@"+sessionStorage.getItem("winner")+"' target='_blank'>/@"+sessionStorage.getItem("winner")+"</a></h1><b class='w3-right'><i class='fa fa-certificate'></i> Certified random draw n°"+sessionStorage.getItem("num_of_draws")+"</b>");
			$('.vote_nb').html(sessionStorage.getItem("vote_nb"));
			$('.coms_nb').html(sessionStorage.getItem("coms_nb"));
			$('.vote_nb_valid').html(sessionStorage.getItem("vote_valid"));
			$('.coms_nb_valid').html(sessionStorage.getItem("coms_valid"));

			$("#wait").hide();

			$('#participants').show();
			$('#result').show();
		}

		function randomNumber(max)
		{
			return Math.floor(Math.random()*(max));
		}

		// FUNCTION END

		// EVENT

		$("#coms_box").change(function()
		{
			if($("#coms_box").is(":checked") == true)
			{
				$("#coms_field").prop('disabled', false);
			}
			else
			{
				$("#coms_field").prop('disabled', true);
				$("#coms_field").prop('value', "");
				if($("#vote_box").is(":checked") == false)
				{
					$("#vote_box").prop('checked', true);
					$("#vote_field").prop('disabled', false);
				}
			}
		}).change();

		$("#vote_box").change(function()
		{
			if($("#vote_box").is(":checked") == true)
			{
				$("#vote_field").prop('disabled', false);
			}
			else
			{
				$("#vote_field").prop('disabled', true);
				$("#vote_field").prop('value', "");
				if($("#coms_box").is(":checked") == false)
				{
					$("#coms_box").prop('checked', true);
					$("#coms_field").prop('disabled', false);
				}
			}
		}).change();

		$('#link_form').submit(function(event)
		{
			event.preventDefault();
			$("#wait").show();

			// RESET

			$("#tab").html("");
			$("#winner").html("");

			$('#participants').hide();
			$('#result').hide();

			vote_participant = [];
			coms_participant = [];
			participants = [];

			// END RESET

			var link_full = $('#link_field')[0].value;

			if(getAuthorPermlink(link_full) == true)
			{
				getInfoFull(sessionStorage.getItem("author"), sessionStorage.getItem("permlink"));
				setTimeout(getRandomDraw, 1000);
				sessionStorage.clear();
			}
			else
			{
				$("#wait").hide();
			}
		});

		// EVENT END
	</script>
</body>
</html> 
